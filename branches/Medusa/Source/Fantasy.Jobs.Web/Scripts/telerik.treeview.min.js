(function(b){var a=b.telerik;a.treeview=function(e,f){this.element=e;var c=b(e);b.extend(this,f);var d=".t-in:not(.t-state-selected,.t-state-disabled)";b(".t-in.t-state-selected",e).live("mouseenter",a.preventDefault);c.delegate(d,"mouseenter",a.hover).delegate(d,"mouseleave",a.leave).delegate(d,"click",a.delegate(this,this.nodeSelect)).delegate("div:not(.t-state-disabled) .t-in","dblclick",a.delegate(this,this.nodeClick)).delegate(":checkbox","click",a.delegate(this,this.checkboxClick)).delegate(".t-plus, .t-minus","click",a.delegate(this,this.nodeClick));if(this.isAjax()){c.find(".t-plus").each(function(){var h=b(this.parentNode);h.parent().data("loaded",h.next(".t-group").length>0)})}if(this.dragAndDrop){a.bind(this,{nodeDragStart:this.onNodeDragStart,nodeDragging:this.onNodeDragging,nodeDragCancelled:this.onNodeDragCancelled,nodeDrop:this.onNodeDrop,nodeDropped:this.onNodeDropped});a.draganddrop(this.element.id,b.extend({useDragClue:true,draggables:b("div:not(.t-state-disabled) .t-in",e)},a.draganddrop.applyContext(a.draganddrop.treeview,this)))}var g=c.find(".t-item > .t-content");if(g.length>0&&b(g[0]).children().length==0){c.find(".t-icon").hide()}a.bind(this,{expand:this.onExpand,collapse:this.onCollapse,select:b.proxy(function(h){if(h.target==this.element&&this.onSelect){this.onSelect(h)}},this),checked:this.onChecked,error:this.onError,load:this.onLoad,dataBinding:this.onDataBinding,dataBound:this.onDataBound})};a.treeview.prototype={expand:function(c){b(c,this.element).each(b.proxy(function(g,f){var e=b(f);var d=e.find("> .t-group, > .t-content");if((d.length>0&&!d.is(":visible"))||this.isAjax()){this.nodeToggle(null,e)}},this))},collapse:function(c){b(c,this.element).each(b.proxy(function(g,f){var e=b(f);var d=e.find("> .t-group, > .t-content");if(d.length>0&&d.is(":visible")){this.nodeToggle(null,e)}},this))},enable:function(c){this.toggle(c,true)},disable:function(c){this.toggle(c,false)},toggle:function(c,d){b(c,this.element).each(b.proxy(function(g,f){var e=b(f);this.collapse(e);e.find("> div > .t-icon").toggleClass("t-state-default",d).toggleClass("t-state-disabled",!d);e.find("> div > .t-in").toggleClass("t-state-default",d).toggleClass("t-state-disabled",!d)},this))},reload:function(c){var d=this;b(c).each(function(){var e=b(this);e.find(".t-group").remove();d.ajaxRequest(e)})},shouldNavigate:function(c){var e=b(c).closest(".t-item").find("> .t-content, > .t-group");var d=b(c).attr("href");return !((d&&(d.charAt(d.length-1)=="#"||d.indexOf("#"+this.element.id+"-")!=-1))||(e.length>0&&e.children().length==0))},nodeSelect:function(f,d){if(!this.shouldNavigate(d)){f.preventDefault()}var c=b(d);if(!c.hasClass(".t-state-selected")&&!a.trigger(this.element,"select",{item:c.closest(".t-item")[0]})){b(".t-in",this.element).removeClass("t-state-hover t-state-selected");c.addClass("t-state-selected")}},nodeToggle:function(g,f,c){if(g!=null){g.preventDefault()}if(f.data("animating")||!f.find("> div > .t-icon").is(":visible")||f.find("> div > .t-in").hasClass("t-state-disabled")){return}f.data("animating",!c);var h=f.find("> .t-group, > .t-content");var d=!h.is(":visible");if(h.children().length>0&&f.data("loaded")!==false&&!a.trigger(this.element,d?"expand":"collapse",{item:f[0]})){f.find("> div > .t-icon").toggleClass("t-minus",d).toggleClass("t-plus",!d);if(!c){a.fx[d?"play":"rewind"](this.effects,h,{direction:"bottom"},function(){f.data("animating",false)})}else{h[d?"show":"hide"]()}}else{if(d&&this.isAjax()&&(h.length==0||f.data("loaded")===false)){this.ajaxRequest(f)}}},nodeClick:function(g,f){var c=b(f);var d=c.closest(".t-item");if(c.hasClass("t-plus-disabled")||c.hasClass("t-minus-disabled")){return}this.nodeToggle(g,d)},isAjax:function(){return this.ajax||this.ws||this.onDataBinding},url:function(c){return(this.ajax||this.ws)[c]},ajaxOptions:function(d,e){var c={type:"POST",dataType:"text",error:b.proxy(function(h,g){if(a.ajaxError(this.element,"error",h,g)){return}if(g=="parsererror"){alert("Error! The requested URL did not return JSON.")}},this),success:b.proxy(function(g){g=eval("("+g+")");g=g.d||g;this.dataBind(d,g)},this)};c=b.extend(c,e);var f=this.ws?c.data.node={}:c.data;if(d.hasClass("t-item")){f[this.queryString.value]=this.getItemValue(d);f[this.queryString.text]=this.getItemText(d)}if(this.ws){c.data=a.toJson(c.data);c.contentType="application/json; charset=utf-8"}return c},ajaxRequest:function(c){c=c||b(this.element);if(a.trigger(this.element,"dataBinding",{item:c[0]})||(!this.ajax&&!this.ws)){return}c.data("loadingIconTimeout",setTimeout(function(){c.find("> div > .t-icon").addClass("t-loading")},100));b.ajax(this.ajaxOptions(c,{data:{},url:this.url("selectUrl")}))},bindTo:function(d){var c=b(this.element);this.dataBind(c,d)},dataBind:function(f,g){f=b(f);if(g.length==0){b(".t-icon",f).hide();return}var d=f.find("> .t-group");var e=d.length==0;var c=new a.stringBuilder();a.treeview.getGroupHtml(g,c,this.isAjax(),f.hasClass("t-treeview"),this.showCheckBox,e?g[0].Expanded:false,e);f.data("animating",true);if(d.length>0&&f.data("loaded")===false){b(c.string()).prependTo(d)}else{if(d.length>0&&f.data("loaded")!==false){d.html(c.string())}else{if(d.length==0){d=b(c.string()).appendTo(f)}}}a.fx.play(this.effects,d,{direction:"bottom"},function(){f.data("animating",false)});clearTimeout(f.data("loadingIconTimeout"));if(f.hasClass("t-item")){f.data("loaded",true).find(".t-icon:first").removeClass("t-loading").removeClass("t-plus").addClass("t-minus")}a.trigger(this.element,"dataBound")},checkboxClick:function(f,d){var c=b(d).is(":checked");var g=a.trigger(this.element,"checked",{item:b(d).closest(".t-item")[0],checked:c});if(!g){this.nodeCheck(d,c)}else{f.preventDefault()}return g},nodeCheck:function(c,d){b(c,this.element).each(b.proxy(function(i,e){var j=b(e);var h=j.closest(".t-item");var k=b("> div > .t-checkbox",h);var m=this.element.id+"_checkedNodes";var l=k.find(':input[name="'+m+'.Index"]');var g=l.val();k.find(':input[name="'+m+"["+g+'].Text"]').remove();k.find(':input[name="'+m+"["+g+'].Value"]').remove();k.find(":checkbox").attr("checked",d?"checked":"");if(d){var f=new a.stringBuilder();f.cat('<input type="hidden" value="').cat(this.getItemValue(h)).cat('" name="'+m+"[").cat(g).cat('].Value" class="t-input">').cat('<input type="hidden" value="').cat(this.getItemText(h)).cat('" name="'+m+"[").cat(g).cat('].Text" class="t-input">');b(f.string()).appendTo(k)}},this))},getItemText:function(c){return b(c).find("> div > .t-in").text()},getItemValue:function(c){return b(c).find('>div>:input[name="itemValue"]').val()||this.getItemText(c)}};b.extend(a.draganddrop,{treeview:{shouldDrag:function(c){return true},createDragClue:function(c){return c.closest(".t-top,.t-mid,.t-bot").text()},onDragStart:function(d,c){var f=a.trigger(this.element,"nodeDragStart",{item:c.closest(".t-item")[0]});if(!f){this.$dropClue=b('<div class="t-drop-clue" />').appendTo(this.element)}return f},onDragMove:function(k,m){var g;a.trigger(this.element,"nodeDragging",{pageY:k.pageY,dropTarget:k.target,setStatusClass:function(e){g=e},item:m.closest(".t-item")[0]});if(g){this.$dropClue.css("visibility","hidden");return g}if(this.dragAndDrop.dropTargets&&b(k.target).closest(this.dragAndDrop.dropTargets).length>0){return"t-add"}if(!b.contains(this.element,k.target)){this.$dropClue.css("visibility","hidden");return}else{if(b.contains(m.closest(".t-item")[0],k.target)){this.$dropClue.css("visibility","hidden");return"t-denied"}}this.$dropClue.css("visibility","visible");var n="t-insert-middle";var j=b(k.target);var o=j.closest(".t-top,.t-mid,.t-bot");if(o.length>0){var h=o.outerHeight();var c=o.offset().top;var f=j.closest(".t-in");var d=h/(f.length>0?4:2);var q=k.pageY<(c+d);var i=(c+h-d)<k.pageY;var l=f.length>0&&!q&&!i;f.toggleClass("t-state-hover",l);this.$dropClue.css("visibility",l?"hidden":"visible");if(l){n="t-add";this.$dropTarget=j}else{var p=o.position();p.top+=q?0:h;this.$dropClue.css(p)[q?"prependTo":"appendTo"](j.closest(".t-item").find("> div:first"));n="t-insert-middle";if(q&&o.hasClass("t-top")){n="t-insert-top"}if(i&&o.hasClass("t-bot")){n="t-insert-bottom"}}}return n},onDragCancelled:function(d,c){a.trigger(this.element,"nodeDragCancelled",{item:c.closest(".t-item")[0]});this.$dropClue.remove()},onDrop:function(g,c,f){var d=a.trigger(this.element,"nodeDrop",{isValid:!f.find(".t-drag-status").hasClass("t-denied"),dropTarget:g.target,item:c.closest(".t-item")[0]});if(d||!b.contains(this.element,g.target)){this.$dropClue.remove();return d}return d?true:b.proxy(function(e){var h=c.closest(".t-top,.t-mid,.t-bot");var m=h.parent();var p=h.closest(".t-group");if(b.contains(m[0],g.target)){e();this.$dropClue.remove();return}if(m.hasClass("t-last")){m.removeClass("t-last").prev().addClass("t-last").find("> div").removeClass("t-top t-mid").addClass("t-bot")}var o="over";var i;if(this.$dropClue.css("visibility")=="visible"){var j=this.$dropClue.closest(".t-item");o=this.$dropClue.prevAll(".t-in").length>0?"after":"before";i=j.find("> div");j[o](m)}else{i=this.$dropTarget.closest(".t-top,.t-mid,.t-bot");var k=i.next(".t-group");if(k.length===0){k=b('<ul class="t-group" />').appendTo(i.parent());i.prepend('<span class="t-icon t-minus" />')}k.append(m);if(i.find("> .t-icon").hasClass("t-plus")){this.nodeToggle(null,i.parent(),true)}}a.trigger(this.element,"nodeDropped",{destinationItem:i.closest(".t-item")[0],dropPosition:o,item:h.parent(".t-item")[0]});var n=m.parents(".t-group").length;var l=function(r){var s=r.prev().length===0;var q=r.next().length===0;r.toggleClass("t-first",s&&n===1).toggleClass("t-last",q).find("> div").toggleClass("t-top",s&&!q).toggleClass("t-mid",!s&&!q).toggleClass("t-bot",q)};l(m);l(m.prev());l(m.next());if(p.children().length===0){p.prev("div").find(".t-plus,.t-minus").remove();p.remove()}e();this.$dropClue.remove()},this)}}});b.extend(a.treeview,{getItemHtml:function(h,d,i,f,c,e,g){d.cat('<li class="t-item').catIf(" t-first",f&&e==0).catIf(" t-last",e==g-1).cat('">').cat('<div class="').catIf("t-top ",f&&e==0).catIf("t-top",e!=g-1&&e==0).catIf("t-mid",e!=g-1&&e!=0).catIf("t-bot",e==g-1).cat('">');if((i&&h.LoadOnDemand)||(h.Items&&h.Items.length>0)){d.cat('<span class="t-icon').catIf(" t-plus",!h.Expanded).catIf(" t-minus",h.Expanded).catIf("-disabled",h.Enabled===false).cat('"></span>')}if(c&&h.Checkable!==false){d.cat('<input type="checkbox" value="').cat(h.Value).cat('" class="t-input').catIf(" t-state-disabled",h.Enabled===false).cat('"').catIf(' checked="checked"',h.Checked).cat("/>")}d.cat(h.NavigateUrl?'<a href="'+h.NavigateUrl+'" class="t-link ':'<span class="').cat("t-in").catIf(" t-state-disabled",h.Enabled===false).cat('">');if(h.ImageUrl!=null){d.cat('<img class="t-image" alt="" src="').cat(h.ImageUrl).cat('" />')}d.catIf(h.Text,h.Encoded===false).catIf(h.Text.replace(/</g,"&lt;").replace(/>/g,"&gt;"),h.Encoded!==false).cat(h.NavigateUrl?"</a>":"</span>");if(h.Value){d.cat('<input type="hidden" class="t-input" name="itemValue" value="').cat(h.Value).cat('" />')}d.cat("</div>");if(h.Items&&h.Items.length>0){a.treeview.getGroupHtml(h.Items,d,i,false,c,h.Expanded)}d.cat("</li>")},getGroupHtml:function(f,m,e,g,l,d,h){if(h!==false){m.cat('<ul class="t-group').catIf(" t-treeview-lines",g).cat('"').catIf(' style="display:none"',d===false).cat(">")}if(f&&f.length>0){var k=a.treeview.getItemHtml;for(var c=0,j=f.length;c<j;c++){k(f[c],m,e,g,l,c,j)}}if(h!==false){m.cat("</ul>")}}});b.fn.tTreeView=function(c){return a.create(this,{name:"tTreeView",init:function(d,e){return new a.treeview(d,e)},options:c,success:function(d){if(d.isAjax()&&b(d.element).find(".t-item").length==0){d.ajaxRequest()}}})};b.fn.tTreeView.defaults={effects:a.fx.property.defaults("height"),queryString:{text:"Text",value:"Value"}}})(jQuery);